---
title: "Simulation study - after 1st revision"
author: "Zorzetto Dafne"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	warning = FALSE,
	comment = NA,
	dev = "png",
	dpi = 150
)
```

Import libraries

```{r message=FALSE, warning=FALSE}
library(statmod)
library(plot.matrix)
library(matlab)
library(R.matlab)
library(MASS)
library(mvtnorm)
library(MatrixCorrelation)
library(parallel)
library(ggplot2)
library(dplyr)
library(forcats)
library(hrbrthemes)
library(viridis)
```

Import Gibbs sampler for Causal Factor Regression

```{r message=FALSE, warning=FALSE}
#source("simulation_functions.R")
source("../src/BayesCausalFactor_Gibbs.R")
source("../src/StandardFactor_Gibbs.R")
source("../src/BART_BCF.R")
source("../src/code_parallelized.R")
source("../src/plots_functions.R")

load("../Data/results_application_00.RData")
```

### Causal Factor Model

![](model.png)

-   $X$ observed confounders
-   Prior for regression coeff.: $\beta_{jt} \sim N_q (\mu_\beta, \Sigma_\beta)$ for$i \in \{1, \dots, n\}$ and $t\in \{0,1\}$
-   Treatment-specific factors scores: (DDP) $$l_{itj} \sim \sum_{r \geq 1}\pi_{tjr}(x_i)N(\mu_r,\sigma_r^2)$$ $$\pi_{tjr}(x_i) = V_{tjr}(x_i)\prod_{g<r}[1-V_{tjg}(x_i)]$$
-   Treatment-specific factors loadings: (Bhattacharya and Dunson, 2011) $$\lambda_{tj h} \mid \kappa_{t j h}, \iota_{th} \sim N\left(0, \kappa_{tj h}^{-1} \iota_{th}^{-1}\right)$$ with $\kappa_{t j h} \sim Ga(\nu_t / 2, \nu_t / 2)$ and $\iota_{h}=\prod_{l=1}^{h} \delta_{tl} \quad \delta_{t1} \sim Ga\left(a_{t1}, 1\right) \quad \delta_{tl} \sim Ga\left(a_{t2}, 1\right)$
-   Error matrix: $\xi_{it} \sim N_p (0, \mbox{diag}(\psi_{i1t}, \dots, \psi_{ipt}))$

### Settings

We have three settings. Each of them has $n=500$ units, $p=10$ predictors/outcomes, and $J_t=3$ factors (for both treatment levels $t$).

Corresponding to 3 case in the following figure:

![](dags.png)

-   **Setting 1:**
    -   4 confounders: $X_1 \sim N(0,1)$, $X_2 \sim N(1,1)$, $X_3 \sim Be(0.3)$, and $X_4 \sim Be(0.6)$
    -   unmeasured var: $U \sim N(0,2)$
-   **Setting 2:**
    -   4 confounders: $X_1 \sim N(0,1)$, $X_2 \sim N(1,1)$, $X_3 \sim Be(0.3)$, and $X_4 \sim Be(0.6)$
    -   unmeasured var: $U \sim N(0.5 + X_1 + 0.5X_3,0.5)$
-   **Setting 3:**
    -   unmeasured var: $U \sim N(0,2)$
    -   4 confounders: $X_1 \sim N(0.4U,1)$, $X_2 \sim N(1-0.3U,1)$, $X_3 \sim Be(0.3)$, and $X_4 \sim Be(0.6)$

Then each of them has in common the following data generation process:

-   treatment variable: $T \sim Be(expit(0.2 + 0.5X_1+0.2X_3-0.5U))$
-   factor loadings (for each $t$): $\Lambda_t$ is $10\times 3$ matrix with $25\%$ of zeros entries and the remain values with values between $[-1,-0.8]$ and $[0.8,1]$
-   error matrix (for each $t$): $\xi_{it} \sim Unif_p[0,1]$
-   categorical variable for each unit $i$ and for different treatment level $t$ and factor $j$: $C_{ijt}$ depend on variable $X_3$ and $X_4$ (no dependence with $U$)
-   factor score: $l_{itj} \mid C_{ijt}=c \sim N(\mu_{t,c}+\gamma_{t,c}U, 1)$
-   potential outcome: $Y(t) \sim B_t X +\Lambda\_t\eta + \xi_t $


##### Additional Settings

-   **Setting 4:**
    -   using data application
-   **Setting 5:**
    -   addind effect of $U$ directly on $Y$: **
-   **Setting 6:**
    -   addind effect of $U$ directly on $Y$: **
-   **Setting 7:**
    -   setting 1 but with factor loadings $\Lambda_t$ with $25\%$ of zeros entries and the remain values with values between $[-0.5,-0.3]$ and $[0.3,0.5]$

```{r functions_sim, eval=TRUE, message=FALSE, warning=FALSE}
# options for X generation
X_indep_function<-function(n_obs){
  return(X = rbind(rnorm(n_obs,0,1),
                   rnorm(n_obs,1,1),
                   rbinom(n_obs,1,0.3),
                   rbinom(n_obs,1,0.6)))
}
X_depU_function<-function(n_obs, U){
  return(X = rbind(rnorm(n_obs,0.4*U,1),
                   rnorm(n_obs,1-0.3*U,1),
                   rbinom(n_obs,1,0.3),
                   rbinom(n_obs,1,0.6)))
}
# options for U generation
U_indep_function<-function(n_obs){
  return(U = rbind(rnorm(n_obs,0,2)))
}
U_depX_function<-function(n_obs, X){
  return(U = rbind(rnorm(n_obs,0.5+X[,1]+0.5*X[,3],2)))
}

funct_specific_factors<-function(p, j_t, no_zeros=0.6, max_loading=1, perc_nozeros){
  set.seed(1)
  
  L <- noZERO <- studyc <- position <- Lambda_s <- list()
  
  for(s in 1:2){
    L[[s]] <- as.vector(zeros(p, j_t[s]))
    noZERO[[s]] <- (p*j_t[s])*perc_nozeros
    studyc[[s]] <- runif(noZERO[[s]], no_zeros,max_loading)
    sign <- sample(x = length(studyc), size = (length(studyc)/2))
    studyc[[s]][sign] <- studyc[[s]][sign]*(-1)
    position[[s]] <- sample(x = p*j_t[s], size=length(studyc[[s]]))
    L[[s]][position[[s]]] <- studyc[[s]]
    Lambda_s[[s]] <- matrix(L[[s]], p, j_t[s])
  }
  
  return(Lambda_s)
}

# generatoin data mechanism
funct_data_generating<-function(n_tot, p,
                                lim_nozeros_Lambda=0.8, perc_nozeros_Lambda=0.75,
                                max_loading=1, function_Y=1,
                                setting_XU, mean_cl, c_U, seed){
                        
  set.seed(seed)
  
  # useful variables 
  X_t  <- U_t <- list()
  l_all <- Y_all <- list()
  Psi_t <- Y_t <- l_t <- beta_t <- list()
  Y_mis <- l_mis <- list()
  
  # X and U: different settings
  if (setting_XU==1){
    X <- X_indep_function(n_tot)
    U <- U_indep_function(n_tot)} 
  if(setting_XU==2){
    X <- X_indep_function(n_tot)
    U <- U_depX_function(n_tot,X)} 
  if(setting_XU==3) {
    U <- U_indep_function(n_tot)
    X <- X_depU_function(n_tot, U)}
  
  # treatment
  reg_T <- c(-0.2 + c(0.5,0.2)%*%X[c(1,3),] -0.4*U)
  Treat <- rbinom(n_tot,1,exp(reg_T)/(1+exp(reg_T)))
  
  # cluster allocation
  j_t <- sapply(mean_cl,function(x) length(x))
  cl_alloc <- list(matrix(NA,n_tot,j_t[1]),matrix(NA,n_tot,j_t[2]))
  
  for (s in 0:1){
    for (j in 1:j_t[s+1]){
      n_cl=length(mean_cl[[s+1]][[j]])
      if(n_cl==1){
        cl_alloc[[s+1]][,j] <- 1
      }
      if(n_cl==2){
        cl_tr <- rep(2,n_tot)
        cl_tr[(X[1,])>0] <- 1
        cl_alloc[[s+1]][,j] <- cl_tr
      }
      if(n_cl==3){
        cl_tr <- rep(3,n_tot)
        cl_tr[(X[3,])>0] <-1
        cl_tr[((X[1,]+0.2)*(1-X[3,]))>0] <-2
        cl_alloc[[s+1]][,j] <- cl_tr
      }
    }
  }
  
  # factor loadings
  Lambda_t <- funct_specific_factors(p, j_t, 
                                     no_zeros=lim_nozeros_Lambda, 
                                     max_loading=1,
                                     perc_nozeros=perc_nozeros_Lambda)
  
  for(s in 1:2){
    # errors
    Psi_t[[s]] = diag(runif(p,0,1), p)    
    
    #covariates 
    betas <- seq(-2+(s-1)*0.5,1-(s-1)*0.5,length.out=4*p)
    beta_t[[s]] = matrix(betas, nrow=p, ncol=4, byrow=TRUE)
    
    # treatment-specific factors
    l_all[[s]] <- sapply(1:j_t[s], function(j) rnorm(n_tot, 
                                                  mean_cl[[s]][[j]][cl_alloc[[s]][,j]]+
                                                  c_U[[s]][[j]][cl_alloc[[s]][,j]]*U,1))
    
     # Y regression 
  if (function_Y==1){
   Y_all[[s]] <- t(beta_t[[s]]%*%X) + l_all[[s]]%*%t(Lambda_t[[s]]) + 
      mvrnorm(n_tot, rep(0, p), Psi_t[[s]])} 
  if(function_Y==2){
    X[2,] <- X[2,]^2/1.5
    X[3,] <- exp(X[3,])/2
   Y_all[[s]] <- t(beta_t[[s]]%*%X) + l_all[[s]]%*%t(Lambda_t[[s]]) + 
      mvrnorm(n_tot, rep(0, p), Psi_t[[s]])
    } 
  if(function_Y==3) {
    X_U <- rbind(X,U+0.3)
    beta_t[[s]] <- cbind(rep(0.5*s,p),beta_t[[s]])
   Y_all[[s]] <- t(beta_t[[s]]%*%X_U) + l_all[[s]]%*%t(Lambda_t[[s]]) + 
      mvrnorm(n_tot, rep(0, p), Psi_t[[s]])
   }
  }
  
   # division "observed" and "missing" outcome
  for(s in 1:2){
    X_t[[s]] <- X[ ,Treat==(s-1)]
    U_t[[s]] <- U[ ,Treat==(s-1)]
    Y_t[[s]] <- Y_all[[s]][Treat==(s-1), ]
    l_t[[s]] <- l_all[[s]][Treat==(s-1), ]
    Y_mis[[s]] <- Y_all[[s]][Treat==(2-s), ]
    l_mis[[s]] <- l_all[[s]][Treat==(2-s), ]
 }
  
  return(list(data=list(n_t = c(length(U_t[[1]]),length(U_t[[2]])), 
                        Y_t = Y_t, Treat = Treat, X_t = X_t, U_t=U_t),
              factors=list(Lambda_t = Lambda_t, 
                           Psi_t = Psi_t, l_t = l_t),
              parameters=list(j_t = j_t, cl_alloc = cl_alloc, 
                              mean_cl = mean_cl),
              mis_data=list(Y_mis = Y_mis,  l_mis = l_mis, Y_all=Y_all)))
  
}

# generatoin data mechanism
funct_dataapplication_generating<-function(dataset, mean_cl, seed, factors){
                        
  set.seed(seed)
  n_tot=dim(dataset)[1]
  p = 27
  
  # treatment
  Treat <- dataset$treat
  # covariates
  X <- dataset[,31:57]
  X$monitor <- 1*(X$monitor=="CSN")
  X$rural <- 1*(X$rural=="Mix") + 2*(X$rural=="Urban")
  X$aug <- 1*(X$month==8)
  X$sept <- 1*(X$month==9)
  X <- X[,-27]
  X[,c(1:2,5:26)] <- scale(X[,c(1:2,5:26)])
  X <- t(X)
  d_X <- dim(X)[1]
  
  # factor loading
  Lambda_t <- list()
  for (i in 1:2){
    eigenPhi <- eigen(factors[[i]])
    loadK <- varimax(eigenPhi$vectors[,1:3])$loadings
    Lambda_t[[i]]<- loadK[1:27,]
  }
  
  # factor scores
  # cluster allocation
  j_t <- sapply(mean_cl,function(x) length(x))
  cl_alloc <- list(matrix(NA,n_tot,j_t[1]),matrix(NA,n_tot,j_t[2]))
  cl_alloc[[1]][,1] <- 1 +1*(X[3,]!=0)+1*(X[4,]!=0)
  cl_alloc[[1]][,2] <- 1 +1*(X[1,]>0)
  cl_alloc[[1]][,3] <- 1 +1*(X[2,]>0)
  
  cl_alloc[[2]][,1] <- 1 +1*(X[26,]!=0) +1*(X[27,]!=0)
  cl_alloc[[2]][,2] <- 1 +1*(X[8,]>0)
  cl_alloc[[2]][,3] <- 1 +1*(X[1,]>0) +1*(X[2,]>0)
  
  # variables definition
  l_all <- Y_all <- list()
  X_t <- Psi_t <- Y_t <- l_t <- beta_t <- list()
  Y_mis <- l_mis <- list()
  
  for(s in 1:2){
    # errors
    Psi_t[[s]] = diag(runif(p,0,1), p)    
    
    #covariates 
    betas <- seq(-3+(s-1),2+(s-1),length.out=d_X*p)
    beta_t[[s]] = matrix(betas, nrow=p, ncol=d_X, byrow=TRUE)
    
    # treatment-specific factors
    l_all[[s]] <- sapply(1:j_t[s], function(j) rnorm(n_tot, 
                                                  mean_cl[[s]][[j]][cl_alloc[[s]][,j]],1))
    
    # Y regression 
    Y_all[[s]] <- t(beta_t[[s]]%*%X) + l_all[[s]]%*%t(Lambda_t[[s]]) + 
      mvrnorm(n_tot, rep(0, p), Psi_t[[s]])
  }
  
   # division "observed" and "missing" outcome
  for(s in 1:2){
    X_t[[s]] <- X[ ,Treat==(s-1)]
    Y_t[[s]] <- Y_all[[s]][Treat==(s-1), ]
    l_t[[s]] <- l_all[[s]][Treat==(s-1), ]
    Y_mis[[s]] <- Y_all[[s]][Treat==(2-s), ]
    l_mis[[s]] <- l_all[[s]][Treat==(2-s), ]
 }
  
  return(list(data=list(n_t = c(length(Treat)-sum(Treat),sum(Treat)), 
                        Y_t = Y_t, Treat = Treat, X_t = X_t),
              factors=list(Lambda_t = Lambda_t, 
                           Psi_t = Psi_t, l_t = l_t),
              parameters=list(#mean_cl = mean_cl , cl_alloc = cl_alloc, 
                              j_t = j_t),
              mis_data=list(Y_mis = Y_mis,  l_mis = l_mis, Y_all=Y_all)))
  
}

```

```{r n_sample, eval=TRUE, message=FALSE, warning=FALSE}
# number of samples
n_sample = 100
dim_Y = 10
n_units = 500
```

```{r simulation_settings, eval=FALSE, message=FALSE, warning=FALSE}
mu_eta <- list(list(c(-4,0,4),c(-3,3),c(-2,2)),
                 list(c(-5,0,5),c(-3,3),c(-2,0,2)))
gamma_U <- list(list(c(-0.5,0,0.5),c(-0.5,0.5),c(-0.2,0.2)),
                 list(c(-0.5,0,0.5),c(-0.5,0.5),c(-0.2,0,0.2)))

# setting 1:
data_1 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x, 
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=1))

# setting 2:
data_2 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x,
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=2))

# setting 3:
data_3 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x, 
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=3))

# setting 4:
data_4 <- lapply(1:n_sample, function(x) funct_dataapplication_generating(
                   dataset = def_dataset, mean_cl=mu_eta,
                   seed=x, factors=model_00_paper$sigma))

# setting 5: 
data_5 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x, 
                   function_Y=2,
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=1))

# setting 6: 
data_6 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x, 
                   function_Y=3,
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=1))

# setting 7: 
data_7 <- lapply(1:n_sample, function(x) funct_data_generating(
                   n_tot=n_units, p=dim_Y, seed=x, 
                   lim_nozeros_Lambda=0.2, max_loading=0.4,
                   perc_nozeros_Lambda=0.75,
                   mean_cl=mu_eta, c_U=gamma_U, setting_XU=1))
```

### Visualization simulated causal effects

```{r plot_simulation, eval=TRUE, message=FALSE, warning=FALSE}
est_CE_1 <- sapply(data_1,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_2 <- sapply(data_2,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_3 <- sapply(data_3,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_4 <- sapply(data_4,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_5 <- sapply(data_5,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_6 <- sapply(data_6,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))
est_CE_7 <- sapply(data_7,function(x) apply(x$mis_data$Y_all[[2]]-x$mis_data$Y_all[[1]],2,mean))

name_y="simulated causal effect"
ylim_par=c(-2,2)
par(mfrow=c(1,1))
each_CE_plot(est_CE_1, ylim_par=ylim_par,
             name_title="scenario 1", name_y=name_y)
each_CE_plot(est_CE_2, ylim_par=ylim_par,
             name_title="scenario 2", name_y=name_y)
each_CE_plot(est_CE_3, ylim_par=ylim_par,
             name_title="scenario 3", name_y=name_y)
each_CE_plot(est_CE_4, ylim_par=ylim_par,
             name_title="scenario 4", name_y=name_y)
each_CE_plot(est_CE_5, ylim_par=ylim_par,
             name_title="scenario 5", name_y=name_y)
each_CE_plot(est_CE_6, ylim_par=ylim_par,
             name_title="scenario 6", name_y=name_y)
each_CE_plot(est_CE_7, ylim_par=ylim_par,
             name_title="scenario 7", name_y=name_y)

true_CE_1 <- apply(est_CE_1,1,mean)
true_CE_2 <- apply(est_CE_2,1,mean)
true_CE_3 <- apply(est_CE_3,1,mean)
true_CE_4 <- apply(est_CE_4,1,mean)
true_CE_5 <- apply(est_CE_5,1,mean)
true_CE_6 <- apply(est_CE_6,1,mean)
true_CE_7 <- apply(est_CE_7,1,mean)
```

# Estimation model

```{r estimation_models, eval=FALSE, message=FALSE, warning=FALSE}
# setting 1:
model_1_mix <- mclapply(data_1, BayesCausalFactor_parall, mc.cores = 5) 
model_1_stand <- mclapply(data_1, StandardFactor_parall, mc.cores = 5)
model_1_bart <- mclapply(data_1, parallel_funct_bart, mc.cores = 5)
model_1_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_1[[x]]$data$Y_t, 
                                                              X_t = data_1[[x]]$data$X_t, 
                                                              Treat = data_1[[x]]$data$Treat))

# setting 2:
model_2_mix <- mclapply(data_2, BayesCausalFactor_parall, mc.cores = 5) 
model_2_stand <- mclapply(data_2, StandardFactor_parall, mc.cores = 5)
model_2_bart <- mclapply(data_2, parallel_funct_bart, mc.cores = 5)
model_2_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_2[[x]]$data$Y_t, 
                                                              X_t = data_2[[x]]$data$X_t, 
                                                              Treat = data_2[[x]]$data$Treat))

# setting 3:
model_3_mix <- mclapply(data_3, BayesCausalFactor_parall, mc.cores = 5)
model_3_stand <- mclapply(data_3, StandardFactor_parall, mc.cores = 5)
model_3_bart <- mclapply(data_3, parallel_funct_bart, mc.cores = 5)
model_3_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_3[[x]]$data$Y_t, 
                                                              X_t = data_3[[x]]$data$X_t, 
                                                              Treat = data_3[[x]]$data$Treat))

# setting 4:
model_4_mix <- mclapply(data_4, BayesCausalFactor_parall, mc.cores = 3)
model_4_stand <- mclapply(data_4, StandardFactor_parall, mc.cores = 3)
model_4_bart <- mclapply(data_4, parallel_funct_bart, mc.cores = 3)
model_4_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_4[[x]]$data$Y_t, 
                                                              X_t = data_4[[x]]$data$X_t, 
                                                              Treat = data_4[[x]]$data$Treat))

# setting 5:
model_5_mix <- mclapply(data_5, BayesCausalFactor_parall, mc.cores = 5) 
model_5_stand <- mclapply(data_5, StandardFactor_parall, mc.cores = 5)
model_5_bart <- mclapply(data_5, parallel_funct_bart, mc.cores = 5)
model_5_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_5[[x]]$data$Y_t, 
                                                              X_t = data_5[[x]]$data$X_t, 
                                                              Treat = data_5[[x]]$data$Treat))

# setting 6:
model_6_mix <- mclapply(data_6, BayesCausalFactor_parall, mc.cores = 5) 
model_6_stand <- mclapply(data_6, StandardFactor_parall, mc.cores = 5)
model_6_bart <- mclapply(data_6, parallel_funct_bart, mc.cores = 5)
model_6_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_6[[x]]$data$Y_t, 
                                                              X_t = data_6[[x]]$data$X_t, 
                                                              Treat = data_6[[x]]$data$Treat))

# setting 7:
model_7_mix <- mclapply(data_7, BayesCausalFactor_parall, mc.cores = 5) 
model_7_stand <- mclapply(data_7, StandardFactor_parall, mc.cores = 5)
model_7_bart <- mclapply(data_7, parallel_funct_bart, mc.cores = 5)
model_7_bcf <- lapply(1:n_sample, function(x) BCF_estimation(Y_t = data_7[[x]]$data$Y_t, 
                                                              X_t = data_7[[x]]$data$X_t, 
                                                              Treat = data_7[[x]]$data$Treat))

```

### Comparison bias

```{r bias, eval=TRUE}

simulated_ITE <- function(data){
  ITE <- data$mis_data$Y_all[[2]]-data$mis_data$Y_all[[1]]
  t<- data$data$Treat
  return(rbind(ITE[t==0,],ITE[t==1,]) )
}

ITE_data1 <- lapply(data_1, function(d) simulated_ITE(d))
ITE_data2 <- lapply(data_2, function(d) simulated_ITE(d))
ITE_data3 <- lapply(data_3, function(d) simulated_ITE(d))
ITE_data4 <- lapply(data_4, function(d) simulated_ITE(d))
ITE_data5 <- lapply(data_5, function(d) simulated_ITE(d))
ITE_data6 <- lapply(data_6, function(d) simulated_ITE(d))
ITE_data7 <- lapply(data_7, function(d) simulated_ITE(d))

bias_function<- function(ite_simulated, ite_estimated){
  
  n_units <- dim(ite_simulated)[1]
  dim_Y <- dim(ite_simulated)[2]
  
  bias_CE_mean <- apply(ite_estimated-ite_simulated,2,mean)
  mse_CE_mean <- apply((ite_estimated-ite_simulated)^2,2,mean)
  
return(list(bias_CE_mean = bias_CE_mean,
            mse_CE_mean = mse_CE_mean))
}

#prepare BART data
delist_bart_tauY <- function(results){
  return(sapply(results, function(d) unlist(d$tau_Y)))
}
delist_bcf_tauY <- function(results){
  seq_positions<- seq(1,length(results),2)
  return(sapply(seq_positions, function(d) unlist(results[[d]])))
}

# setting 1
bias_1_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data1[[s]], ite_estimated = model_1_mix[[s]]$CE_ite))
bias_1_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data1[[s]], ite_estimated = model_1_stand[[s]]$CE_ite))
bias_1_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data1[[s]], 
                ite_estimated = delist_bart_tauY(model_1_bart[[s]])))
bias_1_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data1[[s]], 
                ite_estimated = delist_bcf_tauY(model_1_bcf[[s]][[1]])))

# setting 2
bias_2_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data2[[s]], ite_estimated = model_2_mix[[s]]$CE_ite))
bias_2_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data2[[s]], ite_estimated = model_2_stand[[s]]$CE_ite))
bias_2_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data2[[s]], 
                ite_estimated = delist_bart_tauY(model_2_bart[[s]])))
bias_2_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data2[[s]], 
                ite_estimated = delist_bcf_tauY(model_2_bcf[[s]][[1]])))

# setting 3
bias_3_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data3[[s]], ite_estimated = model_3_mix[[s]]$CE_ite))
bias_3_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data3[[s]], ite_estimated = model_3_stand[[s]]$CE_ite))
bias_3_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data3[[s]], 
                ite_estimated = delist_bart_tauY(model_3_bart[[s]])))
bias_3_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data3[[s]], 
                ite_estimated = delist_bcf_tauY(model_3_bcf[[s]][[1]])))
# setting 4
bias_4_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data4[[s]], ite_estimated = model_4_mix[[s]]$CE_ite))
bias_4_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data4[[s]], ite_estimated = model_4_stand[[s]]$CE_ite))
bias_4_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data4[[s]], 
                ite_estimated = delist_bart_tauY(model_4_bart[[s]])))
bias_4_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data4[[s]], 
                ite_estimated = delist_bcf_tauY(model_4_bcf[[s]][[1]])))

# setting 5
bias_5_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data5[[s]], ite_estimated = model_5_mix[[s]]$CE_ite))
bias_5_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data5[[s]], ite_estimated = model_5_stand[[s]]$CE_ite))
bias_5_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data5[[s]], 
                ite_estimated = delist_bart_tauY(model_5_bart[[s]])))
bias_5_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data5[[s]], 
                ite_estimated = delist_bcf_tauY(model_5_bcf[[s]][[1]])))

# setting 6
bias_6_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data6[[s]], ite_estimated = model_6_mix[[s]]$CE_ite))
bias_6_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data6[[s]], ite_estimated = model_6_stand[[s]]$CE_ite))
bias_6_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data6[[s]], 
                ite_estimated = delist_bart_tauY(model_6_bart[[s]])))
bias_6_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data6[[s]], 
                ite_estimated = delist_bcf_tauY(model_6_bcf[[s]][[1]])))

# setting 7
bias_7_mix <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data7[[s]], ite_estimated = model_7_mix[[s]]$CE_ite))
bias_7_stand <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data7[[s]], ite_estimated = model_7_stand[[s]]$CE_ite))
bias_7_bart <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data7[[s]], 
                ite_estimated = delist_bart_tauY(model_7_bart[[s]])))
bias_7_bcf <- lapply(1:n_sample, function(s) 
  bias_function(ite_simulated = ITE_data7[[s]], 
                ite_estimated = delist_bcf_tauY(model_7_bcf[[s]][[1]])))
```

### Plots results: bias and MSE of causal effects

```{r echo=FALSE, eval=FALSE}
cbPalette <- c("#0971E8","#8ADAFF","#384F69","#D90224","#EBB600","#E67300")

### PLOT PAPER
boxplot_models_general<-function(data, list_model, xlab_name, ylab_name){
  bias_boxplot=as.data.frame(cbind(Xi=data,
                                   Q=rep(list_model,
                                         each=dim_Y*n_sample),
                                   cov=rep(paste0("Y ",c(1:dim_Y)),n_sample*length(list_model))))
  bias_boxplot$Q=factor(bias_boxplot$Q)
  bias_boxplot$Q=ordered(bias_boxplot$Q, 
                         levels =list_model)
  bias_boxplot$cov=factor(bias_boxplot$cov)
  bias_boxplot$cov=ordered(bias_boxplot$cov, levels=paste0("Y ",c(1:dim_Y)))
  bias_boxplot$Xi=as.numeric(bias_boxplot$Xi)
  
  #pdf(file="bias_sim.pdf",width=10, height=5)
  ggplot(bias_boxplot, aes(x=cov, y=Xi, fill=Q, color=Q, alpha=0.2)) + 
    #scale_fill_manual(values=cbPalette[1:3], name="")+   ####REMOVE FOR standard color
    #scale_color_manual(values=cbPalette[1:3], name="")+   ####REMOVE FOR standard color
    geom_boxplot(lwd=0.3,fatten = 1.5, outlier.size = 0.3)+
    scale_x_discrete(labels = c('Y 1' = expression(Y[1]), 'Y 2' = expression(Y[2]),
                                'Y 3' = expression(Y[3]), 'Y 4' = expression(Y[4]),
                                'Y 5' = expression(Y[5]), 'Y 6' = expression(Y[6]),
                                'Y 7' = expression(Y[7]), 'Y 8' = expression(Y[8]),
                                'Y 9' = expression(Y[9]), 'Y 10' = expression(Y[10])))+
    #geom_hline(yintercept = 0, col="#00BC4B", size=0.4) +
    theme(panel.background = element_rect(fill='white'),
          plot.background = element_rect(fill ="white"),
          #panel.grid.minor = element_line(color = "grey"),
          axis.title = element_text(size=14),
          legend.position = "top",
          legend.text=element_text(size=10),
          plot.title = element_text(hjust = 0.2),
          title =element_text(size=18),
          legend.background = element_rect(fill='transparent'),
          panel.grid.major = element_line(color = "grey",size = 0.1))+
    ylab(ylab_name) +
    xlab(xlab_name) +
    labs(fill = "") +
    guides(color = FALSE, alpha = FALSE)
  #dev.off()
}

boxplot_models_scen4<-function(data, list_model, xlab_name, ylab_name){
  dim_Y=27
  n_sample=20
  bias_boxplot=as.data.frame(cbind(Xi=data,
                                   Q=rep(list_model,
                                         each=dim_Y*n_sample),
                                   cov=rep(paste0("Y ",c(1:dim_Y)),
                                           n_sample*length(list_model))))
  bias_boxplot$Q=factor(bias_boxplot$Q)
  bias_boxplot$Q=ordered(bias_boxplot$Q, 
                         levels =list_model)
  bias_boxplot$cov=factor(bias_boxplot$cov)
  bias_boxplot$cov=ordered(bias_boxplot$cov, levels=paste0("Y ",c(1:dim_Y)))
  bias_boxplot$Xi=as.numeric(bias_boxplot$Xi)
  
  #pdf(file="bias_sim.pdf",width=10, height=5)
  ggplot(bias_boxplot, aes(x=cov, y=Xi, fill=Q, color=Q, alpha=0.2)) + 
    #scale_fill_manual(values=cbPalette[1:3], name="")+   ####REMOVE FOR standard color
    #scale_color_manual(values=cbPalette[1:3], name="")+   ####REMOVE FOR standard color
    geom_boxplot(lwd=0.3,fatten = 1.5, outlier.size = 0.3)+
    scale_x_discrete(labels = c('Y 1' = expression(Y[1]), 'Y 2' = expression(Y[2]),
                                'Y 3' = expression(Y[3]), 'Y 4' = expression(Y[4]),
                                'Y 5' = expression(Y[5]), 'Y 6' = expression(Y[6]),
                                'Y 7' = expression(Y[7]), 'Y 8' = expression(Y[8]),
                                'Y 9' = expression(Y[9]), 'Y 10' = expression(Y[10]),
                                'Y 11' = expression(Y[11]), 'Y 12' = expression(Y[12]),
                                'Y 13' = expression(Y[13]), 'Y 14' = expression(Y[14]),
                                'Y 15' = expression(Y[15]), 'Y 16' = expression(Y[16]),
                                'Y 17' = expression(Y[17]), 'Y 18' = expression(Y[18]),
                                'Y 19' = expression(Y[19]), 'Y 20' = expression(Y[20]),
                                'Y 21' = expression(Y[21]), 'Y 22' = expression(Y[22]),
                                'Y 23' = expression(Y[23]), 'Y 24' = expression(Y[24]),
                                'Y 25' = expression(Y[25]), 'Y 26' = expression(Y[26]),
                                'Y 27' = expression(Y[27])))+
    #geom_hline(yintercept = 0, col="#00BC4B", size=0.4) +
    theme(panel.background = element_rect(fill='white'),
          plot.background = element_rect(fill ="white"),
          #panel.grid.minor = element_line(color = "grey"),
          axis.title = element_text(size=14),
          legend.position = "top",
          legend.text=element_text(size=10),
          plot.title = element_text(hjust = 0.2),
          title =element_text(size=18),
          legend.background = element_rect(fill='transparent'),
          panel.grid.major = element_line(color = "grey",size = 0.1))+
    ylab(ylab_name) +
    xlab(xlab_name) +
    labs(fill = "") +
    guides(color = FALSE, alpha = FALSE)
  #dev.off()
}


boxplot_models_general(data=c(t(sapply(bias_1_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_1_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_1_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_1_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 1", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_2_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_2_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_2_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_2_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 2", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_3_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_3_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_3_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_3_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 3", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_4_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_4_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_4_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_4_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 4", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_5_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_5_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_5_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_5_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 5", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_6_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_6_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_6_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_6_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 6", ylab_name="Bias")
boxplot_models_general(data=c(t(sapply(bias_7_mix, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_7_stand, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_7_bart, function(i) unlist(i$bias_CE_mean))),
                              t(sapply(bias_7_bcf, function(i) unlist(i$bias_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 7", ylab_name="Bias")

boxplot_models_general(data=c(t(sapply(bias_1_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_1_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_1_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_1_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 1", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_2_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_2_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_2_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_2_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 2", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_3_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_3_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_3_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_3_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 3", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_4_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_4_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_4_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_4_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 4", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_5_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_5_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_5_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_5_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 5", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_6_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_6_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_6_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_6_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 6", ylab_name="MSE")
boxplot_models_general(data=c(t(sapply(bias_7_mix, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_7_stand, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_7_bart, function(i) unlist(i$mse_CE_mean))),
                              t(sapply(bias_7_bcf, function(i) unlist(i$mse_CE_mean)))),
                       list_model=c("CausalFA","StandardFA","bart","BCF"),
                       xlab_name="Scenario 7", ylab_name="MSE")
```

### Check coverage

```{r echo=FALSE, eval=FALSE}

coverage_function<- function(true_ate, ite_intervals, perc_quant=0.95){
  
  dim_Y <- length(true_ate)
  values <- c((1-perc_quant)/2,1-(1-perc_quant)/2)
  quantiles_est <- apply(ite_intervals, 1, quantile, prob=values)
  
  coverage <- sapply(1:dim_Y, function(i) 1*(true_ate[i]<quantiles_est[2,i] &
                                               true_ate[i]>quantiles_est[1,i]))
  
return(coverage=coverage)
}

#prepare BART data
delist_bart_ate <- function(results){
  return(sapply(results, function(d) unlist(d$mean_CE)))
}
#prepare BCF data
delist_bcf_ate <- function(results){
  seq_positions<- seq(1,length(results),2)+1
  return(sapply(seq_positions, function(d) unlist(results[[d]])))
}

boxplot_coverage<-function(table_cov){
  
  dim_Y <- dim(table_cov)[2]-2
  table_cov <- table_cov[,1:dim_Y]
  name_models <- rownames(table_cov)
  data_boxplot=as.data.frame(cbind(Xi=c(table_cov),
                                   Q=rep(name_models,dim_Y)))
  data_boxplot$Q=factor(data_boxplot$Q)
  data_boxplot$Q=ordered(data_boxplot$Q, levels =name_models)
  data_boxplot$Xi=as.numeric(data_boxplot$Xi)
  
  #pdf(file="bias_sim.pdf",width=10, height=5)
  ggplot(data_boxplot, aes(x=Q, y=Xi, fill=Q, color=Q, alpha=0.2)) + 
    geom_boxplot(lwd=0.3,fatten = 1.5, outlier.size = 0.3)+
    theme(panel.background = element_rect(fill='white'),
          plot.background = element_rect(fill ="white"),
          axis.title = element_text(size=14),
          legend.position = "top",
          legend.text=element_text(size=10),
          plot.title = element_text(hjust = 0.2),
          title =element_text(size=18),
          legend.background = element_rect(fill='transparent'),
          panel.grid.major = element_line(color = "grey",size = 0.1))+
    ylab("coverage") +
    xlab('') +
    labs(fill = "") +
    guides(color = FALSE, alpha = FALSE)
  #dev.off()
}

# print table
table_coverage <- function(data_mix, data_stand, data_bart, data_bcf){
  table_cov <- rbind(apply(data_mix, 1, mean),
                     apply(data_stand, 1, mean),
                     apply(data_bart, 1, mean),
                     apply(data_bcf, 1, mean))
  
  var_name <- paste0('Y_', 1:(dim(table_cov)[2]))
  rownames(table_cov) <- c("CausalFA","StandardFA","bart","BCF")
  
  table_cov <- cbind(table_cov, apply(table_cov,1,mean),apply(table_cov,1,median))
  colnames(table_cov) <- c(var_name, 'mean', 'median')
  
  return(table_cov)
}

perc_cov=0.95

# setting 1
cov_1_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_1, model_1_mix[[s]]$CE_mean, perc_cov))
cov_1_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_1, model_1_stand[[s]]$CE_mean, perc_cov))
cov_1_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_1, delist_bart_ate(model_1_bart[[s]]), perc_cov))
cov_1_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_1, delist_bcf_ate(model_1_bcf[[s]][[1]]), perc_cov))
# setting 2
cov_2_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_2, model_2_mix[[s]]$CE_mean, perc_cov))
cov_2_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_2, model_2_stand[[s]]$CE_mean, perc_cov))
cov_2_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_2, delist_bart_ate(model_2_bart[[s]]), perc_cov))
cov_2_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_2, delist_bcf_ate(model_2_bcf[[s]][[1]]), perc_cov))
# setting 3
cov_3_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_3, model_3_mix[[s]]$CE_mean, perc_cov))
cov_3_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_3, model_3_stand[[s]]$CE_mean, perc_cov))
cov_3_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_3, delist_bart_ate(model_3_bart[[s]]), perc_cov))
cov_3_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_3, delist_bcf_ate(model_3_bcf[[s]][[1]]), perc_cov))
# setting 4
cov_4_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_4, model_4_mix[[s]]$CE_mean, perc_cov))
cov_4_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_4, model_4_stand[[s]]$CE_mean, perc_cov))
cov_4_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_4, delist_bart_ate(model_4_bart[[s]]), perc_cov))
cov_4_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_4, delist_bcf_ate(model_4_bcf[[s]][[1]]), perc_cov))
# setting 5
cov_5_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_5, model_5_mix[[s]]$CE_mean, perc_cov))
cov_5_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_5, model_5_stand[[s]]$CE_mean, perc_cov))
cov_5_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_5, delist_bart_ate(model_5_bart[[s]]), perc_cov))
cov_5_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_5, delist_bcf_ate(model_5_bcf[[s]][[1]]), perc_cov))
# setting 6
cov_6_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_6, model_6_mix[[s]]$CE_mean, perc_cov))
cov_6_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_6, model_6_stand[[s]]$CE_mean, perc_cov))
cov_6_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_6, delist_bart_ate(model_6_bart[[s]]), perc_cov))
cov_6_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_6, delist_bcf_ate(model_6_bcf[[s]][[1]]), perc_cov))
# setting 7
cov_7_mix <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_7, model_7_mix[[s]]$CE_mean, perc_cov))
cov_7_stand <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_7, model_7_stand[[s]]$CE_mean, perc_cov))
cov_7_bart <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_7, delist_bart_ate(model_7_bart[[s]]), perc_cov))
cov_7_bcf <- sapply(1:n_sample, function(s) 
  coverage_function(true_CE_7, delist_bcf_ate(model_7_bcf[[s]][[1]]), perc_cov))

table_cov_1 <- table_coverage(cov_1_mix,cov_1_stand,cov_1_bart,cov_1_bcf)
table_cov_2 <- table_coverage(cov_2_mix,cov_2_stand,cov_2_bart,cov_2_bcf)
table_cov_3 <- table_coverage(cov_3_mix,cov_3_stand,cov_3_bart,cov_3_bcf)
table_cov_4 <- table_coverage(cov_4_mix,cov_4_stand,cov_4_bart,cov_4_bcf)
table_cov_5 <- table_coverage(cov_5_mix,cov_5_stand,cov_5_bart,cov_5_bcf)
table_cov_6 <- table_coverage(cov_6_mix,cov_6_stand,cov_6_bart,cov_6_bcf)
table_cov_7 <- table_coverage(cov_7_mix,cov_7_stand,cov_7_bart,cov_7_bcf)

boxplot_coverage(table_cov_1)
boxplot_coverage(table_cov_2)
boxplot_coverage(table_cov_3)
boxplot_coverage(table_cov_4)
boxplot_coverage(table_cov_5)
boxplot_coverage(table_cov_6)
boxplot_coverage(table_cov_7)

```

